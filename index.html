<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Tài khoản</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="../Assets/css/qltk.css">
    <link rel="stylesheet" href="../Assets/css/all.css"> 
</head>
<body>
    <!-- Mobile menu button -->
    <button class="mobile-menu-btn" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="container-fluid p-0">
        <div class="row g-0">
            <!-- Sidebar -->
            <div class="col-lg-2 px-0 sidebar" id="sidebar">
                <div class="py-4 text-center text-white">
                    <h5>Point of sale</h5>
                </div>
                <div class="mt-2">
                    <a href="dashboard.php"><i class="fas fa-tachometer-alt me-2"></i> Dashboard</a>
                    <a href="qltk.html" class="active"><i class="fas fa-users me-2"></i> Tài khoản</a>                    
                    <a href="#productSubmenu" data-bs-toggle="collapse"><i class="fas fa-mobile-alt me-2"></i> Sản phẩm</a>
                    <div class="collapse" id="productSubmenu">
                        <a href="qlsp.html"><i class="fas fa-mobile me-2"></i> Điện thoại</a>
                        <a href="qlpk.html"><i class="fas fa-headphones me-2"></i> Phụ kiện</a>
                    </div>
                    <a href="qldm.html"><i class="fas fa-list me-2"></i>Danh mục</a>
                    <a href="xldv.html"><i class="fas fa-shopping-cart me-2"></i> Quản lý bán hàng</a>
                    <a href="qldh.html"><i class="fas fa-clipboard-list me-2"></i> Đơn hàng</a>
                    <a href="qlkh.html"><i class="fas fa-user-friends me-2"></i> Khách hàng</a>
                    <a href="bcpt.html"><i class="fas fa-chart-bar me-2"></i> Báo cáo và phân tích</a>
                    <a href="ttcn.html"><i class="fas fa-user-cog me-2"></i> Thông tin cá nhân</a>
                    <a href="../Backend/logout.php"><i class="fas fa-sign-out-alt me-2"></i> Đăng xuất</a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content col-lg-10 p-3 p-md-4">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                    <h2 class="inner-title mb-3 mb-md-0">Quản lý tài khoản</h2>
                    <button type="button" class="btn bg-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="fas fa-plus me-2"></i>Thêm nhân viên mới
                    </button>
                </div>

                <!-- Search and Filter -->
                <div class="search-and-filter row mb-4">
                    <div class="col-12 col-md-6 mb-3 mb-md-0">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Tìm kiếm nhân viên...">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="d-flex justify-content-md-end">
                            <select class="form-select w-100 w-md-75 w-lg-50">
                                <option selected>Tất cả nhân viên</option>
                                <option>Nhân viên đang hoạt động</option>
                                <option>Nhân viên không hoạt động</option>
                                <option>Tài khoản bị khóa</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Staff List -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Danh sách nhân viên</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nhân viên</th>
                                        <th>Email</th>
                                        <th>Ngày tạo</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="employeeTableBody">
                                    <!-- Danh sách nhân viên sẽ được tải động từ backend -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade add-modal" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">Thêm nhân viên mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="fullName" class="form-label">Họ tên đầy đủ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email (Gmail) <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" required>
                            <div class="form-text">Email này sẽ được sử dụng để gửi liên kết đăng nhập.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn bg-primary" id="createUserBtn">Tạo tài khoản</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div class="modal fade detail-modal" id="userDetailModal" tabindex="-1" aria-labelledby="userDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userDetailModalLabel">Thông tin nhân viên</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-4 mb-md-0">
                            <img src="https://via.placeholder.com/150" class="img-fluid rounded-circle mb-3" alt="Avatar" style="max-width: 150px;" id="detailAvatar">
                            <h5 id="detailFullName"></h5>
                            <p class="text-muted" id="detailRole">Nhân viên bán hàng</p>
                            <span class="badge status-badge" id="detailStatus"></span>
                        </div>
                        <div class="col-md-8">
                            <h6 class="border-bottom pb-2 mb-3">Thông tin cá nhân</h6>
                            <div class="row mb-2">
                                <div class="col-sm-4 text-muted">Email:</div>
                                <div class="col-sm-8" id="userEmail"></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 text-muted">Số điện thoại:</div>
                                <div class="col-sm-8" id="userPhone">Chưa cập nhật</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 text-muted">Ngày tạo:</div>
                                <div class="col-sm-8" id="userCreatedAt"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn bg-primary" id="editUserBtn">
                        <i class="fa-solid fa-pen-to-square"></i> Chỉnh sửa
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thông báo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="alertMessage"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            // Toggle sidebar
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('show');
                sidebarOverlay.classList.toggle('show');
                document.body.classList.toggle('sidebar-open');
            });
            
            // Close sidebar when clicking overlay
            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('show');
                sidebarOverlay.classList.remove('show');
                document.body.classList.remove('sidebar-open');
            });
            
            // Close sidebar on window resize if screen becomes large
            window.addEventListener('resize', function() {
                if (window.innerWidth > 992 && sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                    sidebarOverlay.classList.remove('show');
                    document.body.classList.remove('sidebar-open');
                }
            });

            // Hàm hiển thị thông báo
            function showAlert(message) {
                document.getElementById('alertMessage').textContent = message;
                new bootstrap.Modal(document.getElementById('alertModal')).show();
            }

            // Hàm hiển thị loading
            function showLoading() {
                const tbody = document.getElementById('employeeTableBody');
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Đang tải...</td></tr>';
            }

            // Tải danh sách nhân viên khi trang được tải
            showLoading();
            fetch('../Backend/user_management.php?action=list')
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('Không tìm thấy API: ' + response.statusText);
                        }
                        throw new Error('Phản hồi từ server không thành công: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const tbody = document.getElementById('employeeTableBody');
                        tbody.innerHTML = '';
                        data.data.forEach(employee => {
                            const statusText = employee.status === 'active' ? 'Đang hoạt động' : employee.status === 'locked' ? 'Bị khóa' : 'Không hoạt động';
                            const statusClass = employee.status === 'active' ? 'bg-success' : employee.status === 'locked' ? 'bg-danger' : 'bg-secondary';
                            const row = `
                                <tr>
                                    <td data-label="Nhân viên">
                                        <div class="d-flex align-items-center">
                                            <img src="${employee.avatar || '/source/Assets/images/anhdaidien.png'}" class="profile-img me-3" alt="Avatar">
                                            <div>
                                                <p class="fw-bold mb-0">${employee.full_name}</p>
                                                <small class="text-muted">Nhân viên bán hàng</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td data-label="Email">${employee.email}</td>
                                    <td data-label="Ngày tạo">${new Date(employee.created_at).toLocaleDateString('vi-VN')}</td>
                                    <td data-label="Trạng thái">
                                        <span class="badge ${statusClass} status-badge">${statusText}</span>
                                    </td>
                                    <td data-label="Thao tác">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" title="Xem chi tiết" data-user-id="${employee.user_id}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning" title="${employee.status === 'locked' ? 'Mở khóa tài khoản' : 'Khóa tài khoản'}" data-user-id="${employee.user_id}">
                                                <i class="fas ${employee.status === 'locked' ? 'fa-unlock' : 'fa-lock'}"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" title="Gửi lại email đăng nhập" data-user-id="${employee.user_id}">
                                                <i class="fas fa-envelope"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>`;
                            tbody.insertAdjacentHTML('beforeend', row);
                        });
                    } else {
                        showAlert(data.message);
                        if (data.message === 'Chỉ quản trị viên mới có quyền truy cập') {
                            setTimeout(() => {
                                window.location.href = 'login.php';
                            }, 2000);
                        }
                    }
                })
                .catch(error => {
                    showAlert('Đã xảy ra lỗi khi tải danh sách nhân viên: ' + error.message);
                });

            // Tạo tài khoản nhân viên mới
            document.getElementById("createUserBtn").addEventListener("click", function() {
                let fullName = document.getElementById("fullName").value.trim();
                let email = document.getElementById("email").value.trim();

                if (!fullName || !email) {
                    showAlert("Vui lòng nhập đầy đủ họ tên và email!");
                    return;
                }

                fetch('../Backend/user_management.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ full_name: fullName, email: email })
                })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('Không tìm thấy API: ' + response.statusText);
                        }
                        throw new Error('Phản hồi từ server không thành công: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showAlert(data.message);
                        const tbody = document.getElementById('employeeTableBody');
                        const newRow = `
                            <tr>
                                <td data-label="Nhân viên">
                                    <div class="d-flex align-items-center">
                                        <img src="/source/Assets/images/anhdaidien.png" class="profile-img me-3" alt="Avatar">
                                        <div>
                                            <p class="fw-bold mb-0">${fullName}</p>
                                            <small class="text-muted">Nhân viên bán hàng</small>
                                        </div>
                                    </div>
                                </td>
                                <td data-label="Email">${email}</td>
                                <td data-label="Ngày tạo">${new Date().toLocaleDateString("vi-VN")}</td>
                                <td data-label="Trạng thái">
                                    <span class="badge bg-success status-badge">Đang hoạt động</span>
                                </td>
                                <td data-label="Thao tác">
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" title="Xem chi tiết" data-user-id="${data.user_id}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" title="Khóa tài khoản" data-user-id="${data.user_id}">
                                            <i class="fas fa-lock"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" title="Gửi lại email đăng nhập" data-user-id="${data.user_id}">
                                            <i class="fas fa-envelope"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>`;
                        tbody.insertAdjacentHTML("beforeend", newRow);
                        bootstrap.Modal.getInstance(document.getElementById("addUserModal")).hide();
                        document.getElementById("fullName").value = "";
                        document.getElementById("email").value = "";
                    } else {
                        showAlert(data.message);
                        if (data.message === 'Chỉ quản trị viên mới có quyền truy cập') {
                            setTimeout(() => {
                                window.location.href = 'login.php';
                            }, 2000);
                        }
                    }
                })
                .catch(error => {
                    showAlert('Đã xảy ra lỗi khi tạo tài khoản: ' + error.message);
                });
            });

            // Xử lý các nút thao tác
            document.getElementById('employeeTableBody').addEventListener('click', function (e) {
                const userId = e.target.closest('button')?.dataset.userId;

                // Xem chi tiết
                if (e.target.classList.contains('fa-eye') || e.target.closest('.btn-outline-primary')) {
                    fetch(`../Backend/user_management.php?action=detail&user_id=${userId}`)
                        .then(response => {
                            if (!response.ok) {
                                if (response.status === 404) {
                                    throw new Error('Không tìm thấy API: ' + response.statusText);
                                }
                                throw new Error('Phản hồi từ server không thành công: ' + response.statusText);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                const user = data.data;
                                document.getElementById('detailFullName').textContent = user.full_name;
                                document.getElementById('detailStatus').textContent = user.status === 'active' ? 'Đang hoạt động' : user.status === 'locked' ? 'Bị khóa' : 'Không hoạt động';
                                document.getElementById('detailStatus').className = `badge status-badge ${user.status === 'active' ? 'bg-success' : user.status === 'locked' ? 'bg-danger' : 'bg-secondary'}`;
                                document.getElementById('userEmail').textContent = user.email;
                                document.getElementById('userCreatedAt').textContent = new Date(user.created_at).toLocaleDateString('vi-VN');
                                new bootstrap.Modal(document.getElementById('userDetailModal')).show();
                            } else {
                                showAlert(data.message);
                                if (data.message === 'Chỉ quản trị viên mới có quyền truy cập') {
                                    setTimeout(() => {
                                        window.location.href = 'login.php';
                                    }, 2000);
                                }
                            }
                        })
                        .catch(error => {
                            showAlert('Đã xảy ra lỗi khi xem chi tiết nhân viên: ' + error.message);
                        });
                }

                // Khóa/mở khóa tài khoản
                if (e.target.classList.contains('fa-lock') || e.target.classList.contains('fa-unlock')) {
                    const action = e.target.classList.contains('fa-lock') ? 'khóa' : 'mở khóa';
                    if (confirm(`Bạn có chắc chắn muốn ${action} tài khoản này không?`)) {
                        fetch(`../Backend/user_management.php?action=toggle_lock&user_id=${userId}`, { method: 'PATCH' })
                            .then(response => {
                                if (!response.ok) {
                                    if (response.status === 404) {
                                        throw new Error('Không tìm thấy API: ' + response.statusText);
                                    }
                                    throw new Error('Phản hồi từ server không thành công: ' + response.statusText);
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.success) {
                                    showAlert(data.message);
                                    const statusBadge = e.target.closest('tr').querySelector('.status-badge');
                                    statusBadge.textContent = data.message.includes('khóa') ? 'Bị khóa' : 'Đang hoạt động';
                                    statusBadge.className = `badge status-badge ${data.message.includes('khóa') ? 'bg-danger' : 'bg-success'}`;
                                    e.target.classList.toggle('fa-lock');
                                    e.target.classList.toggle('fa-unlock');
                                    e.target.closest('button').title = data.message.includes('khóa') ? 'Mở khóa tài khoản' : 'Khóa tài khoản';
                                } else {
                                    showAlert(data.message);
                                    if (data.message === 'Chỉ quản trị viên mới có quyền truy cập') {
                                        setTimeout(() => {
                                            window.location.href = 'login.php';
                                        }, 2000);
                                    }
                                }
                            })
                            .catch(error => {
                                showAlert('Đã xảy ra lỗi khi khóa/mở khóa tài khoản: ' + error.message);
                            });
                    }
                }

                // Gửi lại email
                if (e.target.classList.contains('fa-envelope')) {
                    fetch(`../Backend/user_management.php?action=resend_email&user_id=${userId}`, { method: 'PATCH' })
                        .then(response => {
                            if (!response.ok) {
                                if (response.status === 404) {
                                    throw new Error('Không tìm thấy API: ' + response.statusText);
                                }
                                throw new Error('Phản hồi từ server không thành công: ' + response.statusText);
                            }
                            return response.json();
                        })
                        .then(data => {
                            showAlert(data.message);
                            if (data.message === 'Chỉ quản trị viên mới có quyền truy cập') {
                                setTimeout(() => {
                                    window.location.href = 'login.php';
                                }, 2000);
                            }
                        })
                        .catch(error => {
                            showAlert('Đã xảy ra lỗi khi gửi lại email: ' + error.message);
                        });
                }
            });

            // Xử lý sự kiện khi modal chi tiết nhân viên bị đóng
            document.getElementById('userDetailModal').addEventListener('hidden.bs.modal', function () {
                const modalBackdrops = document.querySelectorAll('.modal-backdrop');
                modalBackdrops.forEach(backdrop => backdrop.remove());
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            });
        });
    </script>
</body>
</html>
